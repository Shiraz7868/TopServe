<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TopServe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === MUKAMMAL CSS ISI FILE KE ANDAR === */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { /* ... (Poora CSS pichle jawab se) ... */ }
        html, body { /* ... */ }
        body { /* ... */ }
        .container { max-width: 1000px; /* Admin panel thora bara */ }
        /* ... Baqi ka poora admin-specific CSS pichle jawab se ... */
    </style>
</head>
<body>
    <div class="container admin-container">
        <h1>Admin Panel</h1>
        
        <div class="card">
            <h2>Pending Deposit Requests</h2>
            <ul id="deposit-requests-list" class="order-list"><li>Loading...</li></ul>
        </div>
        
        <div class="card">
            <h2>Manage User Balance (Manual)</h2>
            <div class="user-management">
                <div><label>Username or Email</label><input type="text" id="user-search" placeholder="Enter username..."></div>
                <div><label>Amount (PKR)</label><input type="number" id="deposit-amount" placeholder="e.g., 100"></div>
                <button id="add-balance-btn">Add Balance</button>
            </div>
        </div>

        <div class="card">
            <h2>All Pending Orders</h2>
            <ul id="admin-order-list" class="order-list"><li>Loading...</li></ul>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://lyqdnxaxisnipeogtzfm.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cWRueGF4aXNuaXBlb2d0emZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDA5NzEsImV4cCI6MjA2NzE3Njk3MX0.RLhRacgqtvXk2-qaQ3ZCLYkcshg5_kIN5Mko6WMouWw'; // <-- YAHAN APNI SECRET KEY DAALEIN
    const supabaseAdmin = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    async function loadDepositRequests() {
        const list = document.getElementById('deposit-requests-list');
        const { data, error } = await supabaseAdmin.from('deposit_requests').select(`*, profile:profiles(username)`).eq('status', 'Pending').order('created_at');
        if (error) { list.innerHTML = '<li>Error loading requests.</li>'; return; }
        if (data.length === 0) { list.innerHTML = '<li>No pending deposit requests.</li>'; return; }
        list.innerHTML = data.map(req => `
            <li class="deposit-request-item">
                User: <strong>${req.profile ? req.profile.username : 'N/A'}</strong> | Amount: <strong>${req.amount} PKR</strong> | Method: ${req.method}<br>
                Sender: ${req.sender_number} | Time: ${new Date(req.created_at).toLocaleString()}<br>
                <img src="${req.screenshot_data}" alt="Screenshot" style="max-width: 200px; margin-top: 10px; cursor: pointer;" onclick="window.open(this.src)">
                <div class="deposit-controls" style="margin-top:10px;">
                    <button class="approve-btn" data-req-id="${req.id}" data-user-id="${req.user_id}" data-amount="${req.amount}" style="background-color: var(--secondary-color);">Approve</button>
                    <button class="reject-btn" data-req-id="${req.id}" style="background-color: var(--danger-color);">Reject</button>
                </div>
            </li>`).join('');
    }

    document.getElementById('deposit-requests-list').addEventListener('click', async (e) => {
        const reqId = e.target.dataset.reqId; if (!reqId) return;
        const approveBtn = e.target.closest('.approve-btn');
        const rejectBtn = e.target.closest('.reject-btn');
        if (!approveBtn && !rejectBtn) return;

        (approveBtn || rejectBtn).innerText = 'Processing...';
        (approveBtn || rejectBtn).disabled = true;

        if (approveBtn) {
            const userId = approveBtn.dataset.userId; const amount = parseFloat(approveBtn.dataset.amount);
            const { data: profile } = await supabaseAdmin.from('profiles').select('balance').eq('id', userId).single();
            const newBalance = (parseFloat(profile.balance) || 0) + amount;
            await supabaseAdmin.from('profiles').update({ balance: newBalance }).eq('id', userId);
            await supabaseAdmin.from('deposit_requests').update({ status: 'Completed' }).eq('id', reqId);
            alert("Deposit approved!");
        } else if (rejectBtn) {
            await supabaseAdmin.from('deposit_requests').update({ status: 'Rejected' }).eq('id', reqId);
            alert("Request rejected.");
        }
        loadDepositRequests();
    });

    // ... (Baqi ka Admin Panel ka JS pichle jawab se copy kar lein) ...
    loadDepositRequests();
</script>
</body>
</html>
