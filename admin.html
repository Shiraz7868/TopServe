<!-- admin.html (Updated Version) -->
<!DOCTYPE html><html lang="en"><head>
    <title>Admin Panel</title>
    <!-- ... (head content) ... -->
</head><body>
    <div class="container admin-container">
        <h1>Admin Panel</h1>
        
        <!-- Deposit Requests Section (Naya) -->
        <div class="card">
            <h2>Pending Deposit Requests</h2>
            <ul id="deposit-requests-list" class="order-list"></ul>
        </div>

        <!-- User Balance Management Section (Purana) -->
        <div class="card user-management">...</div>
        
        <!-- All Orders Section (Purana) -->
        <div class="card">...</div>
    </div>
<script>
    const SUPABASE_URL = 'https://lyqdnxaxisnipeogtzfm.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cWRueGF4aXNuaXBlb2d0emZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDA5NzEsImV4cCI6MjA2NzE3Njk3MX0.RLhRacgqtvXk2-qaQ3ZCLYkcshg5_kIN5Mko6WMouWw';
    const supabaseAdmin = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
    
    // Naya function deposit requests load karne ke liye
    async function loadDepositRequests() {
        const { data, error } = await supabaseAdmin.from('deposit_requests').select(`*, profile:profiles(username)`).eq('status', 'Pending').order('created_at');
        const list = document.getElementById('deposit-requests-list');
        list.innerHTML = '';
        if (data.length === 0) { list.innerHTML = '<li>No pending deposit requests.</li>'; return; }
        data.forEach(req => {
            const li = document.createElement('li');
            li.className = 'order-item';
            li.innerHTML = `
                User: <strong>${req.profile.username}</strong> | Amount: <strong>${req.amount} PKR</strong><br>
                Method: ${req.method} | Sender: ${req.sender_number}<br>
                <a href="${req.screenshot_url}" target="_blank">View Screenshot</a>
                <div style="margin-top:10px;">
                    <button class="approve-btn" data-req-id="${req.id}" data-user-id="${req.user_id}" data-amount="${req.amount}">Approve</button>
                    <button class="reject-btn" data-req-id="${req.id}" style="background:var(--danger-color)">Reject</button>
                </div>`;
            list.appendChild(li);
        });
    }

    // Approve/Reject ke liye Event Listener
    document.getElementById('deposit-requests-list').addEventListener('click', async (e) => {
        const reqId = e.target.dataset.reqId;
        if (!reqId) return;

        if (e.target.classList.contains('approve-btn')) {
            const userId = e.target.dataset.userId;
            const amount = parseFloat(e.target.dataset.amount);
            
            // 1. User ka balance get karein
            const { data: profile } = await supabaseAdmin.from('profiles').select('balance').eq('id', userId).single();
            const newBalance = (parseFloat(profile.balance) || 0) + amount;

            // 2. Balance update karein
            await supabaseAdmin.from('profiles').update({ balance: newBalance }).eq('id', userId);
            
            // 3. Request ko "Completed" mark karein
            await supabaseAdmin.from('deposit_requests').update({ status: 'Completed' }).eq('id', reqId);
            
            alert("Deposit approved and balance updated!");
        } else if (e.target.classList.contains('reject-btn')) {
            await supabaseAdmin.from('deposit_requests').update({ status: 'Rejected' }).eq('id', reqId);
            alert("Request rejected.");
        }
        loadDepositRequests();
    });

    // Page load hotay hi baqi functions ke sath isay bhi call karein
    loadDepositRequests();
    // loadAllOrders();
</script>
</body></html>
