<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - TopServe</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style> .container { max-width: 900px !important; } </style>
</head>
<body>
    <div class="container admin-container">
        <h1>Admin Panel</h1>
        <div class="card user-management">
            <h2>Manage User Balance</h2>
            <div><label>Username</label><input type="text" id="user-search" placeholder="Enter username..."></div>
            <div><label>Amount</label><input type="number" id="deposit-amount" placeholder="e.g., 100"></div>
            <button id="add-balance-btn">Add Balance</button>
        </div>
        <div class="card">
            <h2>All Pending Orders</h2>
            <ul id="admin-order-list" class="order-list"><li>Loading orders...</li></ul>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://lyqdnxaxisnipeogtzfm.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cWRueGF4aXNuaXBlb2d0emZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDA5NzEsImV4cCI6MjA2NzE3Njk3MX0.RLhRacgqtvXk2-qaQ3ZCLYkcshg5_kIN5Mko6WMouWw'; // <-- Yahan apni SERVICE ROLE KEY daalein
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
        const loadAllOrders = async () => { const { data, error } = await supabaseClient.from('orders').select(`*, profile:profiles(username)`).neq('status', 'Completed').order('created_at'); const orderList = document.getElementById('admin-order-list'); orderList.innerHTML = ''; data.forEach(order => { const li = document.createElement('li'); li.className = 'order-item admin-order-item'; li.innerHTML = `<div>User: <strong>${order.profile.username}</strong> | Service: <strong>${order.service_name}</strong><br>Code: ${order.referral_code}</div><div>Progress: <input type="number" value="${order.completed_referrals}" class="completed-input"> / ${order.total_referrals}</div><div><button class="update-progress" data-id="${order.id}">Update</button><button class="mark-complete" data-id="${order.id}" data-total="${order.total_referrals}" style="background-color: #27ae60;">Complete</button></div>`; orderList.appendChild(li); }); };
        const addBalance = async () => { const username = document.getElementById('user-search').value.trim(); const amount = parseFloat(document.getElementById('deposit-amount').value); if (!username || !amount) return; const { data: profile, error } = await supabaseClient.from('profiles').select('id, balance').eq('username', username).single(); if (error || !profile) return alert("User not found."); const newBalance = parseFloat(profile.balance) + amount; await supabaseClient.from('profiles').update({ balance: newBalance }).eq('id', profile.id); alert(`Balance updated for ${username}.`); };
        document.getElementById('add-balance-btn').addEventListener('click', addBalance);
        document.getElementById('admin-order-list').addEventListener('click', async (e) => { const orderId = e.target.dataset.id; if (!orderId) return; if (e.target.classList.contains('update-progress')) { const completedCount = e.target.closest('.order-item').querySelector('.completed-input').value; await supabaseClient.from('orders').update({ completed_referrals: completedCount }).eq('id', orderId); } else if (e.target.classList.contains('mark-complete')) { const total = e.target.dataset.total; await supabaseClient.from('orders').update({ status: 'Completed', completed_referrals: total }).eq('id', orderId); } loadAllOrders(); });
        loadAllOrders();
    </script>
</body>
</html>
