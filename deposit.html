<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit Funds - TopServe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS bilkul waisa hi hai, koi tabdeeli nahi */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { /* ... color variables ... */ }
        /* ... poora CSS code pichle jawab se ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML ka poora structure bilkul waisa hi hai, koi tabdeeli nahi -->
        <div id="step1" class="step active">...</div>
        <div id="step2" class="step">...</div>
        <div id="step3" class="step">...</div>
    </div>

<script>
    const SUPABASE_URL = 'https://lyqdnxaxisnipeogtzfm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cWRueGF4aXNuaXBlb2d0emZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDA5NzEsImV4cCI6MjA2NzE3Njk3MX0.RLhRacgqtvXk2-qaQ3ZCLYkcshg5_kIN5Mko6WMouWw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const screenshotFile = document.getElementById('screenshot-file');
    const submitBtn = document.getElementById('submit-deposit-btn');
    
    async function checkUser() { /* ... (waisa hi hai) ... */ }
    checkUser();
    
    document.getElementById('next-btn').addEventListener('click', () => { /* ... (waisa hi hai) ... */ });
    document.getElementById('back-btn').addEventListener('click', () => { /* ... (waisa hi hai) ... */ });
    screenshotFile.addEventListener('change', (e) => { /* ... (waisa hi hai) ... */ });

    // === NAYA SUBMIT DEPOSIT KA LOGIC ===
    submitBtn.addEventListener('click', async () => {
        submitBtn.disabled = true;
        submitBtn.innerText = "Submitting...";
        
        const file = screenshotFile.files[0];
        if (!file) {
            alert("Please select a screenshot file.");
            submitBtn.disabled = false; submitBtn.innerText = "Submit Deposit Request";
            return;
        }

        const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;

        try {
            // === YEH HAI NAYA AUR BEHTAR TAREQA ===
            // Step 1: Ek temporary, secure upload URL banayein
            const { data: signedUrlData, error: signedUrlError } = await supabaseClient.storage
                .from('deposit-screenshots')
                .createSignedUploadUrl(fileName);

            if (signedUrlError) throw signedUrlError;

            // Step 2: Us secure URL par file ko upload karein
            const { error: uploadError } = await fetch(signedUrlData.signedUrl, {
                method: 'PUT',
                headers: { 'Content-Type': file.type },
                body: file
            });

            if (uploadError) throw new Error("File upload failed.");

            // Step 3: File ka public URL hasil karein taake admin dekh sake
            const { data: urlData } = supabaseClient.storage
                .from('deposit-screenshots')
                .getPublicUrl(signedUrlData.path);
            
            // Step 4: Ab request ko database mein save karein
            const request = {
                user_id: currentUser.id,
                method: document.getElementById('method').value,
                amount: document.getElementById('amount').value,
                sender_number: document.getElementById('sender-number').value,
                screenshot_url: urlData.publicUrl
            };

            const { data: requestData, error: requestError } = await supabaseClient.from('deposit_requests').insert(request).select().single();
            if (requestError) throw requestError;

            // Step 5: Confirmation screen dikhayein
            document.getElementById('request-details').innerHTML = `
                Request ID: ${requestData.id}<br>
                Amount: ${requestData.amount} PKR<br>
                Method: ${requestData.method}`;
            step2.classList.remove('active');
            step3.classList.add('active');

        } catch (error) {
            alert("An error occurred: " + error.message);
            console.error(error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "Submit Deposit Request";
        }
    });
</script>
</body>
</html>
