<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - TopServe</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h2>Welcome, <span id="username">User</span>!</h2>
            <button id="logout-btn" style="width: auto; background-color: var(--danger-color);">Logout</button>
        </div>
        <div class="balance-card">
            <h3>YOUR BALANCE</h3>
            <span class="balance-amount"><span id="balance">0.00</span> PKR</span>
        </div>
        <!-- Naya Phone Number Add Kar Diya Gaya Hai -->
        <p class="deposit-info">To deposit, send JazzCash/EasyPaisa to <strong>+923017815162</strong> and WhatsApp the Transaction ID and your username to the same number.</p>
        
        <div class="card" style="margin-top: 20px;">
            <h2>Place New Order</h2>
            <!-- Order Form HTML waisa hi hai -->
            <label for="service-select">1. Select Service</label>
            <select id="service-select">...</select>
            <div class="order-form-grid">
                <div><label for="ref-code">2. Your Code</label><input type="text" id="ref-code" placeholder="DeNet Code"></div>
                <div><label for="ref-count">3. Quantity</label><input type="number" id="ref-count" min="5" max="10" value="5"></div>
            </div>
            <div class="balance-card" style="background: var(--surface-color); padding: 15px; margin: 10px 0;">
                <h3>Total Cost: <strong id="total-cost" style="color: var(--secondary-color); font-size: 24px;">50.00 PKR</strong></h3>
            </div>
            <button id="place-order-btn">Confirm & Place Order</button>
        </div>
        
        <div class="card">
            <h2>My Recent Orders</h2>
            <ul id="order-list" class="order-list"></ul>
        </div>
    </div>
<script>
    const SUPABASE_URL = 'https://lyqdnxaxisnipeogtzfm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5cWRueGF4aXNuaXBlb2d0emZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MDA5NzEsImV4cCI6MjA2NzE3Njk3MX0.RLhRacgqtvXk2-qaQ3ZCLYkcshg5_kIN5Mko6WMouWw'; // Apni key yahan daalein
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;
    let userOrders = []; // Orders ko save karne ke liye

    // ... (checkUserSession, updateDashboardUI waisay hi hain) ...
    
    async function loadUserOrders() {
        const { data, error } = await supabaseClient.from('orders').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
        if(data) {
            userOrders = data; // Orders ki list ko update karein
            const orderList = document.getElementById('order-list');
            // ... (baqi loadOrders ka code) ...
        }
    }

    async function placeNewOrder() {
        const btn = document.getElementById('place-order-btn'); btn.disabled = true; btn.innerText = "Placing...";

        // === NAYA BATTERY LIMIT WALA LOGIC ===
        const pendingReferrals = userOrders
            .filter(order => order.status === 'In Progress')
            .reduce((total, order) => total + order.total_referrals, 0);
        
        const newOrderCount = parseInt(document.getElementById('ref-count').value);
        
        if ((pendingReferrals + newOrderCount) > 10) {
            alert(`Battery Limit Exceeded! You have ${pendingReferrals} pending referrals. You can only order ${10 - pendingReferrals} more right now. Please wait for current orders to complete.`);
            btn.disabled = false; btn.innerText = "Confirm & Place Order";
            return;
        }
        
        // ... (Baqi ka placeOrder ka code bilkul waisa hi hai) ...
    }

    // ... (baqi JS code) ...
</script>
</body>
</html>
